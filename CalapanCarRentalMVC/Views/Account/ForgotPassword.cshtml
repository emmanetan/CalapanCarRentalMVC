@{
    ViewData["Title"] = "Forgot Password";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
         <div class="card shadow-sm border-0">
      <div class="card-body">
       <div class="text-center mb-4">
    <i class="fas fa-key text-primary" style="font-size: 4rem;"></i>
        <h2 class="mt-3 text-primary fw-bold">Forgot Password</h2>
  <p class="text-muted">Enter your email to receive a verification code</p>
  </div>

    @if (TempData["Success"] != null)
      {
         <div class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
  <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
      }

  @if (TempData["Error"] != null)
 {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
  <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      }

     <!-- Step 1: Enter Email -->
        <div id="emailStep">
     <form id="emailForm">
        @Html.AntiForgeryToken()
     <div class="mb-3">
       <label class="form-label fw-semibold">Email Address</label>
      <div class="input-group">
     <span class="input-group-text"><i class="fas fa-envelope"></i></span>
    <input type="email" id="emailInput" class="form-control bg-light border-0"
      placeholder="Enter your registered email" required />
  <button type="submit" class="btn btn-primary" id="sendCodeBtn">
    <i class="fas fa-paper-plane me-1"></i>Send Code
       </button>
   </div>
        </div>
          </form>

    <div id="messageArea"></div>
          </div>

  <!-- Step 2: Verify Code (Hidden initially) -->
        <div id="verifyStep" style="display: none;">
            <div class="alert alert-success mb-3">
      <i class="fas fa-check-circle me-2"></i>
               Verification code sent! Check your email inbox.
      </div>

         <form id="verifyForm">
  @Html.AntiForgeryToken()
 <input type="hidden" id="verifyEmail" />

    <div class="mb-3">
    <label class="form-label fw-semibold">Verification Code</label>
        <input type="text" id="codeInput" class="form-control bg-light border-0" 
maxlength="6" placeholder="Enter 6-digit code" required />
      <small class="text-muted">Code expires in 10 minutes</small>
</div>

          <div class="mb-3">
      <label class="form-label fw-semibold">New Password</label>
         <div class="input-group">
    <span class="input-group-text"><i class="fas fa-lock"></i></span>
         <input type="password" id="newPassword" class="form-control bg-light border-0"
placeholder="Enter new password (min 6 characters)" required />
   <button class="btn btn-outline-secondary" type="button" id="togglePassword">
     <i class="fas fa-eye"></i>
  </button>
  </div>
   </div>

   <div class="mb-3">
       <label class="form-label fw-semibold">Confirm Password</label>
        <div class="input-group">
    <span class="input-group-text"><i class="fas fa-lock"></i></span>
 <input type="password" id="confirmPassword" class="form-control bg-light border-0"
    placeholder="Confirm new password" required />
 </div>
       </div>

       <div class="d-grid">
    <button type="submit" class="btn btn-success fw-bold py-2" id="resetBtn">
  <i class="fas fa-key me-1"></i>Reset Password
  </button>
    </div>
    </form>

   <div class="text-center mt-3">
       <button type="button" class="btn btn-link text-danger" id="resendCodeBtn">
   <i class="fas fa-redo me-1"></i>Resend Code
        </button>
 </div>
      </div>

<div class="text-center mt-4">
<a asp-action="Login" class="text-secondary">
   <i class="fas fa-arrow-left me-1"></i>Back to Login
  </a>
     </div>
  </div>
  </div>
</div>
    </div>
</div>

@section Scripts {
    <script>
    $(document).ready(function() {
       // Toggle password visibility
    $('#togglePassword').click(function() {
    const passwordField = $('#newPassword');
      const icon = $(this).find('i');
 
        if (passwordField.attr('type') === 'password') {
    passwordField.attr('type', 'text');
  icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
      passwordField.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
   }
       });

   // Send verification code
            $('#emailForm').submit(function(e) {
       e.preventDefault();
            const email = $('#emailInput').val();
       var emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;

    if (!email || !email.match(emailRegex)) {
 showMessage('Please enter a valid email address', 'danger');
    return;
      }

      $('#sendCodeBtn').prop('disabled', true)
   .html('<i class="fas fa-spinner fa-spin me-1"></i>Sending...');

        $.ajax({
      url: '@Url.Action("SendPasswordResetCode", "Account")',
     type: 'POST',
       data: {
 email: email,
         __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
     },
          success: function(response) {
   if (response.success) {
     $('#verifyEmail').val(email);
    $('#emailStep').slideUp();
      $('#verifyStep').slideDown();
     } else {
  showMessage(response.message, 'danger');
       $('#sendCodeBtn').prop('disabled', false)
        .html('<i class="fas fa-paper-plane me-1"></i>Send Code');
   }
  },
       error: function() {
       showMessage('Error sending code. Please try again.', 'danger');
     $('#sendCodeBtn').prop('disabled', false)
         .html('<i class="fas fa-paper-plane me-1"></i>Send Code');
         }
   });
     });

  // Resend code
      $('#resendCodeBtn').click(function() {
      const email = $('#verifyEmail').val();
   
              $(this).prop('disabled', true)
  .html('<i class="fas fa-spinner fa-spin me-1"></i>Resending...');

      $.ajax({
url: '@Url.Action("SendPasswordResetCode", "Account")',
      type: 'POST',
     data: {
   email: email,
     __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
  },
       success: function(response) {
  if (response.success) {
       showMessage('New code sent! Check your email.', 'success');
       } else {
           showMessage(response.message, 'danger');
      }
      $('#resendCodeBtn').prop('disabled', false)
       .html('<i class="fas fa-redo me-1"></i>Resend Code');
      },
error: function() {
     showMessage('Error resending code. Please try again.', 'danger');
  $('#resendCodeBtn').prop('disabled', false)
  .html('<i class="fas fa-redo me-1"></i>Resend Code');
  }
  });
      });

        // Reset password
  $('#verifyForm').submit(function(e) {
      e.preventDefault();
     
        const email = $('#verifyEmail').val();
     const code = $('#codeInput').val();
    const newPassword = $('#newPassword').val();
       const confirmPassword = $('#confirmPassword').val();

     // Validation
        if (!code || code.length !== 6) {
        showMessage('Please enter the 6-digit verification code', 'warning');
  return;
 }

     if (newPassword.length < 6) {
  showMessage('Password must be at least 6 characters long', 'warning');
return;
     }

    if (newPassword !== confirmPassword) {
           showMessage('Passwords do not match', 'warning');
 return;
    }

  $('#resetBtn').prop('disabled', true)
   .html('<i class="fas fa-spinner fa-spin me-1"></i>Resetting...');

$.ajax({
          url: '@Url.Action("ResetPassword", "Account")',
      type: 'POST',
      data: {
       email: email,
code: code,
 newPassword: newPassword,
   __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
     },
              success: function(response) {
  if (response.success) {
showMessage(response.message, 'success');
     setTimeout(function() {
    window.location.href = '@Url.Action("Login", "Account")';
        }, 2000);
    } else {
      showMessage(response.message, 'danger');
          $('#resetBtn').prop('disabled', false)
  .html('<i class="fas fa-key me-1"></i>Reset Password');
     }
        },
  error: function() {
 showMessage('Error resetting password. Please try again.', 'danger');
    $('#resetBtn').prop('disabled', false)
 .html('<i class="fas fa-key me-1"></i>Reset Password');
   }
   });
     });

  function showMessage(message, type) {
      var alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
          '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + ' me-2"></i>' +
   message +
       '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
   '</div>';
   $('#messageArea').html(alertHtml);

     setTimeout(function() {
         $('#messageArea .alert').fadeOut();
    }, 5000);
}
        });
    </script>
}
