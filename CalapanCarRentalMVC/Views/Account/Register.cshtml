@model CalapanCarRentalMVC.Models.RegisterViewModel
@{
    ViewData["Title"] = "Register";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-car text-primary" style="font-size: 3rem;"></i>
                        <h2 class="mt-3 text-primary fw-bold">Calapan Car Rental</h2>
                    </div>

                    <ul class="nav nav-tabs mb-4 justify-content-center">
                        <li class="nav-item">
                            <a class="nav-link text-secondary" asp-action="Login">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active fw-bold text-danger" asp-action="Register">Register</a>
                        </li>
                    </ul>

                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success">@TempData["Success"]</div>
                    }

                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger">@TempData["Error"]</div>
                    }

                    @if (ViewBag.Warning != null)
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>@ViewBag.Warning
                        </div>
                    }

                    <form asp-action="Register" method="post" id="registerForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FirstName" class="form-label fw-semibold"></label>
                                <input asp-for="FirstName" class="form-control bg-light border-0" placeholder="Ex: Juan" />
                                <span asp-validation-for="FirstName" class="text-danger"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="LastName" class="form-label fw-semibold"></label>
                                <input asp-for="LastName" class="form-control bg-light border-0" placeholder="Ex: Dela Cruz" />
                                <span asp-validation-for="LastName" class="text-danger"></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Email" class="form-label fw-semibold"></label>
                            <div class="input-group">
                                <input asp-for="Email" type="email" class="form-control bg-light border-0" placeholder="Ex: juan.delacruz@example.com" id="emailInput" />
                                <button type="button" class="btn btn-outline-primary" id="sendCodeBtn">
                                    <i class="fas fa-paper-plane me-1"></i>Send Code
                                </button>
                            </div>
                            <span asp-validation-for="Email" class="text-danger"></span>
                            <div id="emailVerificationMessage" class="mt-1"></div>

                            <!-- Verification Code Field (Hidden initially) -->
                            <div id="verificationCodeContainer" style="display: none; overflow: hidden; max-height: 0; transition: max-height 0.3s ease-out;">
                                <div class="input-group mt-2">
                                    <input type="text" class="form-control bg-light border-0" id="verificationCodeInput" placeholder="Enter 6-digit code" maxlength="6" />
                                    <button type="button" class="btn btn-outline-success" id="verifyCodeBtn">
                                        <i class="fas fa-check me-1"></i>Verify
                                    </button>
                                </div>
                                <div id="verificationCodeMessage" class="mt-1"></div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="PhoneNumber" class="form-label fw-semibold"></label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-0">+63</span>
                                <input asp-for="PhoneNumber" class="form-control bg-light border-0" placeholder="9123456789" maxlength="10" pattern="[0-9]*" inputmode="numeric" id="phoneNumberInput" />
                            </div>
                            <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                            <small class="text-muted">Enter 10 digits starting with 9 (e.g., 9123456789)</small>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Address" class="form-label fw-semibold"></label>
                            <textarea asp-for="Address" class="form-control bg-light border-0" rows="2" placeholder="Ex: 123 Main Street, Calapan City, Oriental Mindoro"></textarea>
                            <span asp-validation-for="Address" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Password" class="form-label fw-semibold"></label>
                            <input asp-for="Password" type="password" class="form-control bg-light border-0" placeholder="Ex: Password123" id="passwordInput" />
                            <span asp-validation-for="Password" class="text-danger"></span>

                            <!-- Password Strength Meter -->
                            <div class="password-strength-meter mt-2" id="passwordStrengthMeter" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <small class="text-muted">Password Strength:</small>
                                    <small id="strengthText" class="fw-bold"></small>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    <div id="strengthBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label asp-for="ConfirmPassword" class="form-label fw-semibold"></label>
                            <input asp-for="ConfirmPassword" type="password" class="form-control bg-light border-0" placeholder="Ex: Password123" />
                            <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input asp-for="AgreeToTerms" class="form-check-input" type="checkbox" id="agreeToTermsCheckbox" />
                                <label class="form-check-label" for="agreeToTermsCheckbox">
                                    I have read and agree to the <a asp-controller="Home" asp-action="Privacy" target="_blank">Terms of Service</a> and <a asp-controller="Home" asp-action="Privacy" target="_blank">Privacy Policy</a>
                                </label>
                            </div>
                            <span asp-validation-for="AgreeToTerms" class="text-danger d-block" id="agreeToTermsError"></span>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-danger fw-bold py-2" id="registerBtn">
                                <i class="fas fa-user-plus me-2"></i>Register
                            </button>
                        </div>
                    </form>

                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>Complete your profile after registration to start renting cars
                        </small>
                    </div>

                    <div class="text-center mt-2">
                        <small class="text-muted">
                            Already have an account? <a asp-action="Login" class="text-danger fw-bold">Login here</a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
                 $(document).ready(function() {
               var emailVerified = false;

               // Phone Number Input Validation - Only allow digits
   $('#phoneNumberInput').on('input', function() {
  // Remove any non-digit characters
     this.value = this.value.replace(/[^0-9]/g, '');
         
        // Limit to 10 digits
          if (this.value.length > 10) {
    this.value = this.value.slice(0, 10);
       }
            });

            // Prevent non-numeric keypress
 $('#phoneNumberInput').on('keypress', function(e) {
     // Allow only digits (0-9)
         if (e.which < 48 || e.which > 57) {
 e.preventDefault();
        }
  });

             // Password Strength Meter
                       $('#passwordInput').on('input', function() {
               var password = $(this).val();
                   var strengthMeter = $('#passwordStrengthMeter');
                var strengthBar = $('#strengthBar');
         var strengthText = $('#strengthText');

                  if (password.length === 0) {
         strengthMeter.hide();
            return;
          }

           strengthMeter.show();

                    // Calculate password strength
             var strength = 0;
                        var strengthLevel = '';
                     var barColor = '';
                   var barWidth = 0;

               // Length check
                 if (password.length >= 8) strength += 25;
                  if (password.length >= 12) strength += 15;

           // Lowercase letters
            if (/[a-z]/.test(password)) strength += 15;

                    // Uppercase letters
              if (/[A-Z]/.test(password)) strength += 15;

           // Numbers
                   if (/[0-9]/.test(password)) strength += 15;

           // Special characters
           if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

                      // Determine strength level
                  if (strength <= 35) {
            strengthLevel = 'Low';
                         barColor = 'bg-danger';
           barWidth = 33;
                  } else if (strength <= 70) {
                strengthLevel = 'Medium';
                barColor = 'bg-warning';
           barWidth = 66;
                       } else {
                     strengthLevel = 'High';
              barColor = 'bg-success';
            barWidth = 100;
                    }

                 // Update UI
                strengthBar.removeClass('bg-danger bg-warning bg-success').addClass(barColor);
                  strengthBar.css('width', barWidth + '%');
             strengthBar.attr('aria-valuenow', barWidth);
                      strengthText.text(strengthLevel).removeClass('text-danger text-warning text-success').addClass('text-' + (strengthLevel === 'Low' ? 'danger' : strengthLevel === 'Medium' ? 'warning' : 'success'));
                  });

                // Send Verification Code
                    $('#sendCodeBtn').on('click', function() {
            var email = $('#emailInput').val();
             var btn = $(this);

               if (!email || !isValidEmail(email)) {
           showEmailMessage('Please enter a valid email address', 'danger');
          return;
           }

                 // Disable button and show loading
              btn.prop('disabled', true);
             btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Sending...');

              $.ajax({
              url: '@Url.Action("SendVerificationCode", "Account")',
            type: 'POST',
             data: {
             email: email,
              __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                 },
            success: function(response) {
            console.log('Send code response:', response);
              if (response.success) {
            showEmailMessage(response.message, 'success');
          // Slide out verification code container
               $('#verificationCodeContainer').show();
               $('#verificationCodeContainer').css('max-height', '100px');
                  $('#verificationCodeInput').focus();

              // Change button to "Resend Code"
         btn.html('<i class="fas fa-redo me-1"></i>Resend Code');
         } else {
          showEmailMessage(response.message, 'danger');
          }
            },
               error: function(xhr, status, error) {
                    console.error('Send code error:', xhr, status, error);
               console.error('Response text:', xhr.responseText);
                showEmailMessage('Error sending verification code. Please try again.', 'danger');
                    },
              complete: function() {
           btn.prop('disabled', false);
          }
          });
           });

                  // Verify Code
            $('#verifyCodeBtn').on('click', function() {
                var email = $('#emailInput').val();
         var code = $('#verificationCodeInput').val();
              var btn = $(this);

              if (!code || code.length !== 6) {
           showVerificationMessage('Please enter a valid 6-digit code', 'danger');
                   return;
               }

              // Disable button and show loading
              btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Verifying...');

                  $.ajax({
                url: '@Url.Action("VerifyCode", "Account")',
              type: 'POST',
               data: {
            email: email,
        code: code,
                   __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                 },
             success: function(response) {
                   console.log('Verify code response:', response);
         if (response.success) {
          showVerificationMessage(response.message, 'success');
        emailVerified = true;

          // Disable inputs and change button appearance
          $('#emailInput').prop('readonly', true);
                  $('#verificationCodeInput').prop('readonly', true);
           $('#sendCodeBtn').prop('disabled', true).html('<i class="fas fa-check me-1"></i>Verified');
            btn.prop('disabled', true).html('<i class="fas fa-check-circle me-1"></i>Verified');

             // Add verified badge
              $('#emailInput').addClass('border-success');
              $('#verificationCodeInput').addClass('border-success');
                } else {
              showVerificationMessage(response.message, 'danger');
           emailVerified = false;
              }
           },
        error: function(xhr, status, error) {
                console.error('Verify code error:', xhr, status, error);
                   console.error('Response text:', xhr.responseText);
                 showVerificationMessage('Error verifying code. Please try again.', 'danger');
                emailVerified = false;
          },
         complete: function() {
          if (!emailVerified) {
             btn.prop('disabled', false);
           btn.html('<i class="fas fa-check me-1"></i>Verify');
            }
            }
          });
          });
               // Helper function to validate email
        function isValidEmail(email) {
              var emailRegex = /^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/;
          return emailRegex.test(email);
             }

             // Helper function to show email messages
                    function showEmailMessage(message, type) {
                   var alertClass = 'alert-' + type;
               $('#emailVerificationMessage').html('<small class="' + alertClass + ' d-block p-2 rounded">' + message + '</small>');

                      // Auto-hide success messages after 5 seconds
             if (type === 'success') {
              setTimeout(function() {
              $('#emailVerificationMessage').fadeOut(function() {
               $(this).html('').show();
                     });
            }, 5000);
            }
              }

                 // Helper function to show verification code messages
               function showVerificationMessage(message, type) {
              var alertClass = 'alert-' + type;
             $('#verificationCodeMessage').html('<small class="' + alertClass + ' d-block p-2 rounded">' + message + '</small>');

        // Auto-hide success messages after 5 seconds
                   if (type === 'success') {
                      setTimeout(function() {
               $('#verificationCodeMessage').fadeOut(function() {
                $(this).html('').show();
              });
                 }, 5000);
               }
              }

                    // Reset email verification when email changes
             $('#emailInput').on('input', function() {
            if (emailVerified) {
                 emailVerified = false;
              $('#emailInput').prop('readonly', false).removeClass('border-success');
          $('#verificationCodeContainer').hide().css('max-height', '0');
                $('#verificationCodeInput').val('').prop('readonly', false).removeClass('border-success');
                   $('#sendCodeBtn').prop('disabled', false).html('<i class="fas fa-paper-plane me-1"></i>Send Code');
                    $('#verifyCodeBtn').prop('disabled', false).html('<i class="fas fa-check me-1"></i>Verify');
        $('#emailVerificationMessage').html('');
                 $('#verificationCodeMessage').html('');
                  }
                    });

                  $('#registerForm').on('submit', function(e) {
           var agreeCheckbox = $('#agreeToTermsCheckbox');
        var errorSpan = $('#agreeToTermsError');

     if (!agreeCheckbox.is(':checked')) {
     e.preventDefault();
     errorSpan.text('You must agree to the Terms of Service and Privacy Policy');
   agreeCheckbox.focus();
         return false;
           } else {
       errorSpan.text('');
             }

            // Check if email is verified
  if (!emailVerified) {
         e.preventDefault();
      showEmailMessage('Please verify your email address before registering', 'danger');
      $('#emailInput').focus();
 return false;
          }
    });

             $('#agreeToTermsCheckbox').on('change', function() {
                     var errorSpan = $('#agreeToTermsError');
                 if ($(this).is(':checked')) {
                   errorSpan.text('');
                }
                       });
                 });
    </script>
}

