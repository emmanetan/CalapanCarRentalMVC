@model CalapanCarRentalMVC.Models.RegisterViewModel
@{
    ViewData["Title"] = "Register with Email Verification";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <div class="text-center mb-4">
                        <i class="fas fa-car text-primary" style="font-size: 4rem;"></i>
                        <h2 class="mt-3 text-primary fw-bold">Calapan Car Rental</h2>
                    </div>

                    <ul class="nav nav-tabs mb-4 justify-content-center">
                        <li class="nav-item">
                            <a class="nav-link text-secondary" asp-action="Login">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active fw-bold text-danger">Register</a>
                        </li>
                    </ul>

                    <div id="registrationForm">
                        <form asp-action="Register" method="post" id="regForm">
                            <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                            <!-- Step 1: Email Verification -->
                            <div id="step1">
                                <h5 class="mb-3"><i class="fas fa-envelope me-2"></i>Step 1: Verify Email</h5>

                                <div class="mb-3">
                                    <label asp-for="Email" class="form-label fw-semibold">Email Address</label>
                                    <div class="input-group">
                                        <input asp-for="Email" type="email" class="form-control bg-light border-0"
                                               placeholder="Ex: juan.delacruz@example.com" required id="emailInput" />
                                        <button type="button" class="btn btn-primary" id="sendCodeBtn">
                                            <i class="fas fa-paper-plane me-1"></i>Send Code
                                        </button>
                                    </div>
                                    <span asp-validation-for="Email" class="text-danger"></span>
                                </div>

                                <div class="mb-3" id="codeSection" style="display: none;">
                                    <label class="form-label fw-semibold">Verification Code</label>
                                    <input type="text" class="form-control bg-light border-0" maxlength="6"
                                           placeholder="Ex: 123456" id="codeInput" />
                                    <small class="text-muted">Code expires in 10 minutes</small>
                                </div>

                                <div id="verificationMessage"></div>

                                <button type="button" class="btn btn-success w-100 mb-3" id="verifyBtn" style="display: none;">
                                    <i class="fas fa-check me-1"></i>Verify Code
                                </button>
                            </div>

                            <!-- Step 2: Personal Information (Hidden initially) -->
                            <div id="step2" style="display: none;">
                                <h5 class="mb-3 text-success">
                                    <i class="fas fa-check-circle me-2"></i>Email Verified!
                                </h5>
                                <h5 class="mb-3"><i class="fas fa-user me-2"></i>Step 2: Complete Registration</h5>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="FirstName" class="form-label fw-semibold">First Name</label>
                                        <input asp-for="FirstName" class="form-control bg-light border-0"
                                               placeholder="Ex: Juan" />
                                        <span asp-validation-for="FirstName" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label asp-for="LastName" class="form-label fw-semibold">Last Name</label>
                                        <input asp-for="LastName" class="form-control bg-light border-0"
                                               placeholder="Ex: Dela Cruz" />
                                        <span asp-validation-for="LastName" class="text-danger"></span>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="PhoneNumber" class="form-label fw-semibold">Phone Number</label>
                                    <input asp-for="PhoneNumber" class="form-control bg-light border-0"
                                           placeholder="Ex: 09123456789" />
                                    <span asp-validation-for="PhoneNumber" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Address" class="form-label fw-semibold">Address</label>
                                    <textarea asp-for="Address" class="form-control bg-light border-0" rows="2"
                                              placeholder="Ex: 123 Main Street, Calapan City, Oriental Mindoro"></textarea>
                                    <span asp-validation-for="Address" class="text-danger"></span>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="Password" class="form-label fw-semibold">Password</label>
                                    <input asp-for="Password" type="password" class="form-control bg-light border-0"
                                           placeholder="Ex: Password123" id="passwordInputVerification" />
                                    <span asp-validation-for="Password" class="text-danger"></span>

                                    <!-- Password Strength Meter -->
                                    <div class="password-strength-meter mt-2" id="passwordStrengthMeterVerification" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="text-muted">Password Strength:</small>
                                            <small id="strengthTextVerification" class="fw-bold"></small>
                                        </div>
                                        <div class="progress" style="height: 8px;">
                                            <div id="strengthBarVerification" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label asp-for="ConfirmPassword" class="form-label fw-semibold">Confirm Password</label>
                                    <input asp-for="ConfirmPassword" type="password" class="form-control bg-light border-0"
                                           placeholder="Ex: Password123" />
                                    <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
                                </div>

                                <div class="form-check mb-3">
                                    <input asp-for="AgreeToTerms" class="form-check-input" type="checkbox" />
                                    <label asp-for="AgreeToTerms" class="form-check-label">
                                        I agree to the Terms of Service and Privacy Policy
                                    </label>
                                    <span asp-validation-for="AgreeToTerms" class="text-danger d-block"></span>
                                </div>

                                <div class="d-grid">
                                    <button type="submit" class="btn btn-danger fw-bold py-2">
                                        <i class="fas fa-user-plus me-1"></i>Register
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="text-center mt-3">
                        <small class="text-muted">
                            Already have an account? <a asp-action="Login" class="text-danger fw-bold">Login here</a>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script>
        $(document).ready(function() {
            let emailVerified = false;

            // Password Strength Meter
            $('#passwordInputVerification').on('input', function() {
                var password = $(this).val();
                var strengthMeter = $('#passwordStrengthMeterVerification');
                var strengthBar = $('#strengthBarVerification');
                var strengthText = $('#strengthTextVerification');

                if (password.length === 0) {
                    strengthMeter.hide();
                    return;
                }

                strengthMeter.show();

                // Calculate password strength
                var strength = 0;
                var strengthLevel = '';
                var barColor = '';
                var barWidth = 0;

                // Length check
                if (password.length >= 8) strength += 25;
                if (password.length >= 12) strength += 15;

                // Lowercase letters
                if (/[a-z]/.test(password)) strength += 15;

                // Uppercase letters
                if (/[A-Z]/.test(password)) strength += 15;

                // Numbers
                if (/[0-9]/.test(password)) strength += 15;

                // Special characters
                if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

                // Determine strength level
                if (strength <= 35) {
                    strengthLevel = 'Low';
                    barColor = 'bg-danger';
                    barWidth = 33;
                } else if (strength <= 70) {
                    strengthLevel = 'Medium';
                    barColor = 'bg-warning';
                    barWidth = 66;
                } else {
                    strengthLevel = 'High';
                    barColor = 'bg-success';
                    barWidth = 100;
                }

                // Update UI
                strengthBar.removeClass('bg-danger bg-warning bg-success').addClass(barColor);
                strengthBar.css('width', barWidth + '%');
                strengthBar.attr('aria-valuenow', barWidth);
                strengthText.text(strengthLevel).removeClass('text-danger text-warning text-success').addClass('text-' + (strengthLevel === 'Low' ? 'danger' : strengthLevel === 'Medium' ? 'warning' : 'success'));
            });

            // Send Verification Code
            $('#sendCodeBtn').click(function() {
                const email = $('#emailInput').val();

                if (!email || !email.match(/^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/)) {
                    showMessage('Please enter a valid email address', 'danger');
                    return;
                }

                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Sending...');

                $.ajax({
                    url: '@Url.Action("SendVerificationCode", "Account")',
                    type: 'POST',
                    data: {
                        email: email,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            showMessage(response.message + '. Check your inbox!', 'success');
                            $('#codeSection').slideDown();
                            $('#verifyBtn').slideDown();
                            $('#emailInput').prop('readonly', true);
                            $('#sendCodeBtn').html('<i class="fas fa-check me-1"></i>Sent').removeClass('btn-primary').addClass('btn-success');
                        } else {
                            showMessage(response.message, 'danger');
                            $('#sendCodeBtn').prop('disabled', false).html('<i class="fas fa-paper-plane me-1"></i>Send Code');
                        }
                    },
                    error: function() {
                        showMessage('Error sending verification code. Please try again.', 'danger');
                        $('#sendCodeBtn').prop('disabled', false).html('<i class="fas fa-paper-plane me-1"></i>Send Code');
                    }
                });
            });

            // Verify Code
            $('#verifyBtn').click(function() {
                const email = $('#emailInput').val();
                const code = $('#codeInput').val();

                if (!code || code.length !== 6) {
                    showMessage('Please enter the 6-digit verification code', 'warning');
                    return;
                }

                $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Verifying...');

                $.ajax({
                    url: '@Url.Action("VerifyCode", "Account")',
                    type: 'POST',
                    data: {
                        email: email,
                        code: code,
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            emailVerified = true;
                            showMessage(response.message, 'success');
                            $('#step1').slideUp();
                            $('#step2').slideDown();
                        } else {
                            showMessage(response.message, 'danger');
                            $('#verifyBtn').prop('disabled', false).html('<i class="fas fa-check me-1"></i>Verify Code');
                        }
                    },
                    error: function() {
                        showMessage('Error verifying code. Please try again.', 'danger');
                        $('#verifyBtn').prop('disabled', false).html('<i class="fas fa-check me-1"></i>Verify Code');
                    }
                });
            });

            // Send code on Enter key press
            $('#emailInput').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $('#sendCodeBtn').click();
                }
            });

            // Verify code on Enter key press
            $('#codeInput').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    $('#verifyBtn').click();
                }
            });

            // Form Submission
            $('#regForm').submit(function(e) {
                if (!emailVerified) {
                    e.preventDefault();
                    showMessage('Please verify your email first', 'warning');
                    return false;
                }
            });

            function showMessage(message, type) {
                var alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
                    message +
                    '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                    '</div>';
                $('#verificationMessage').html(alertHtml);

                setTimeout(function() {
                    $('#verificationMessage .alert').fadeOut();
                }, 5000);
            }
        });
    </script>
}
