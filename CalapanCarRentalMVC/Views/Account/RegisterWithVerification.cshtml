@model CalapanCarRentalMVC.Models.RegisterViewModel
@{
    ViewData["Title"] = "Register with Email Verification";
}

<div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
       <div class="card shadow-sm border-0">
  <div class="card-body">
       <div class="text-center mb-4">
    <i class="fas fa-car text-primary" style="font-size: 4rem;"></i>
       <h2 class="mt-3 text-primary fw-bold">Calapan Car Rental</h2>
    </div>

    <ul class="nav nav-tabs mb-4 justify-content-center">
            <li class="nav-item">
   <a class="nav-link text-secondary" asp-action="Login">Login</a>
              </li>
      <li class="nav-item">
   <a class="nav-link active fw-bold text-danger">Register</a>
   </li>
            </ul>

          <div id="registrationForm">
         <form asp-action="Register" method="post" id="regForm">
               <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

          <!-- Step 1: Email Verification -->
   <div id="step1">
       <h5 class="mb-3"><i class="fas fa-envelope me-2"></i>Step 1: Verify Email</h5>
   
 <div class="mb-3">
         <label asp-for="Email" class="form-label fw-semibold">Email Address</label>
       <div class="input-group">
            <input asp-for="Email" type="email" class="form-control bg-light border-0"
               placeholder="Enter your email" required id="emailInput" />
      <button type="button" class="btn btn-primary" id="sendCodeBtn">
     <i class="fas fa-paper-plane me-1"></i>Send Code
        </button>
   </div>
            <span asp-validation-for="Email" class="text-danger"></span>
       </div>

         <div class="mb-3" id="codeSection" style="display: none;">
      <label class="form-label fw-semibold">Verification Code</label>
 <input type="text" class="form-control bg-light border-0" maxlength="6"
     placeholder="Enter 6-digit code" id="codeInput" />
  <small class="text-muted">Code expires in 10 minutes</small>
     </div>

     <div id="verificationMessage"></div>

            <button type="button" class="btn btn-success w-100 mb-3" id="verifyBtn" style="display: none;">
      <i class="fas fa-check me-1"></i>Verify Code
       </button>
       </div>

     <!-- Step 2: Personal Information (Hidden initially) -->
     <div id="step2" style="display: none;">
   <h5 class="mb-3 text-success">
      <i class="fas fa-check-circle me-2"></i>Email Verified!
             </h5>
     <h5 class="mb-3"><i class="fas fa-user me-2"></i>Step 2: Complete Registration</h5>

        <div class="mb-3">
         <label asp-for="FullName" class="form-label fw-semibold">Full Name</label>
      <input asp-for="FullName" class="form-control bg-light border-0"
    placeholder="Enter your full name" />
        <span asp-validation-for="FullName" class="text-danger"></span>
              </div>

       <div class="mb-3">
  <label asp-for="PhoneNumber" class="form-label fw-semibold">Phone Number</label>
         <input asp-for="PhoneNumber" class="form-control bg-light border-0"
           placeholder="09XXXXXXXXX" />
 <span asp-validation-for="PhoneNumber" class="text-danger"></span>
   </div>

       <div class="mb-3">
            <label asp-for="Address" class="form-label fw-semibold">Address</label>
           <textarea asp-for="Address" class="form-control bg-light border-0" rows="2"
   placeholder="Enter your address"></textarea>
           <span asp-validation-for="Address" class="text-danger"></span>
   </div>

          <div class="mb-3">
         <label asp-for="Password" class="form-label fw-semibold">Password</label>
    <input asp-for="Password" type="password" class="form-control bg-light border-0"
       placeholder="Enter password (min 6 characters)" />
              <span asp-validation-for="Password" class="text-danger"></span>
  </div>

      <div class="mb-3">
             <label asp-for="ConfirmPassword" class="form-label fw-semibold">Confirm Password</label>
    <input asp-for="ConfirmPassword" type="password" class="form-control bg-light border-0"
      placeholder="Confirm your password" />
          <span asp-validation-for="ConfirmPassword" class="text-danger"></span>
    </div>

     <div class="form-check mb-3">
            <input asp-for="AgreeToTerms" class="form-check-input" type="checkbox" />
     <label asp-for="AgreeToTerms" class="form-check-label">
         I agree to the Terms of Service and Privacy Policy
      </label>
       <span asp-validation-for="AgreeToTerms" class="text-danger d-block"></span>
    </div>

        <div class="d-grid">
     <button type="submit" class="btn btn-danger fw-bold py-2">
      <i class="fas fa-user-plus me-1"></i>Register
           </button>
          </div>
        </div>
</form>
        </div>

      <div class="text-center mt-3">
  <small class="text-muted">
         Already have an account? <a asp-action="Login" class="text-danger fw-bold">Login here</a>
  </small>
         </div>
          </div>
    </div>
   </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(document).ready(function() {
       let emailVerified = false;

         // Send Verification Code
            $('#sendCodeBtn').click(function() {
       const email = $('#emailInput').val();
   
  if (!email || !email.match(/^[^\s@@]+@@[^\s@@]+\.[^\s@@]+$/)) {
         showMessage('Please enter a valid email address', 'danger');
    return;
     }

    $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Sending...');

      $.ajax({
           url: '@Url.Action("SendVerificationCode", "Account")',
             type: 'POST',
          data: {
               email: email,
    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
  },
   success: function(response) {
     if (response.success) {
         showMessage(response.message + '. Check your inbox!', 'success');
   $('#codeSection').slideDown();
          $('#verifyBtn').slideDown();
         $('#emailInput').prop('readonly', true);
            $('#sendCodeBtn').html('<i class="fas fa-check me-1"></i>Sent').removeClass('btn-primary').addClass('btn-success');
            } else {
     showMessage(response.message, 'danger');
          $('#sendCodeBtn').prop('disabled', false).html('<i class="fas fa-paper-plane me-1"></i>Send Code');
 }
   },
        error: function() {
         showMessage('Error sending verification code. Please try again.', 'danger');
       $('#sendCodeBtn').prop('disabled', false).html('<i class="fas fa-paper-plane me-1"></i>Send Code');
          }
        });
  });

            // Verify Code
            $('#verifyBtn').click(function() {
  const email = $('#emailInput').val();
     const code = $('#codeInput').val();

     if (!code || code.length !== 6) {
           showMessage('Please enter the 6-digit verification code', 'warning');
   return;
 }

       $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>Verifying...');

    $.ajax({
       url: '@Url.Action("VerifyCode", "Account")',
       type: 'POST',
           data: {
              email: email,
               code: code,
             __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
  },
      success: function(response) {
         if (response.success) {
       emailVerified = true;
    showMessage(response.message, 'success');
   $('#step1').slideUp();
    $('#step2').slideDown();
            } else {
  showMessage(response.message, 'danger');
            $('#verifyBtn').prop('disabled', false).html('<i class="fas fa-check me-1"></i>Verify Code');
       }
           },
          error: function() {
 showMessage('Error verifying code. Please try again.', 'danger');
          $('#verifyBtn').prop('disabled', false).html('<i class="fas fa-check me-1"></i>Verify Code');
}
    });
            });

     // Form Submission
            $('#regForm').submit(function(e) {
                if (!emailVerified) {
   e.preventDefault();
              showMessage('Please verify your email first', 'warning');
        return false;
   }
            });

   function showMessage(message, type) {
       var alertHtml = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' +
        message +
          '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
   '</div>';
       $('#verificationMessage').html(alertHtml);
 
   setTimeout(function() {
           $('#verificationMessage .alert').fadeOut();
           }, 5000);
            }
    });
    </script>
}
