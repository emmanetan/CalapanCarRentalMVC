@{
    ViewData["Title"] = "Live Location Tracking";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-map-marked-alt"></i> Live Location Tracking</h2>
                <div>
                    <button id="refreshBtn" class="btn btn-primary">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="mb-0">Active Users: <span id="activeUserCount" class="badge bg-success">0</span></h5>
                            <small class="text-muted">Last updated: <span id="lastUpdate">Never</span></small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                            <label class="form-check-label" for="autoRefreshToggle">
                                Auto-refresh (5s)
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-map"></i> Real-Time Map</h5>
                </div>
                <div class="card-body p-0">
                    <div id="map" style="height: 600px; width: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-users"></i> Active Users</h5>
                </div>
                <div class="card-body p-0">
                    <div id="userList" class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                        <div class="text-center p-4 text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>Loading user locations...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Location History Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-history"></i> Users Location History</h5>
                        <div>
                            <button id="exportHistoryBtn" class="btn btn-sm btn-success">
                                <i class="fas fa-file-excel"></i> Export to CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Filter Controls -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="userFilter" class="form-label">Filter by User:</label>
                            <select id="userFilter" class="form-select">
                                <option value="">All Users</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="timeRangeFilter" class="form-label">Time Range:</label>
                            <select id="timeRangeFilter" class="form-select">
                                <option value="1">Last 1 Hour</option>
                                <option value="6">Last 6 Hours</option>
                                <option value="24" selected>Last 24 Hours</option>
                                <option value="72">Last 3 Days</option>
                                <option value="168">Last 7 Days</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="roleFilter" class="form-label">Filter by Role:</label>
                            <select id="roleFilter" class="form-select">
                                <option value="">All Roles</option>
                                <option value="Admin">Admin</option>
                                <option value="Customer">Customer</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button id="applyFiltersBtn" class="btn btn-primary w-100">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="totalRecordsCount">0</h3>
                                    <small>Total Records</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="uniqueUsersCount">0</h3>
                                    <small>Unique Users</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="avgAccuracyDisplay">0m</h3>
                                    <small>Avg. Accuracy</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="dateRangeDisplay">-</h3>
                                    <small>Date Range</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Location History Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="locationHistoryTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Address</th>
                                    <th>Coordinates</th>
                                    <th>Accuracy</th>
                                    <th>Timestamp</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="locationHistoryBody">
                                <tr>
                                    <td colspan="8" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin fa-2x my-4"></i>
                                        <p>Loading location history...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Location history pagination">
                        <ul class="pagination justify-content-center" id="historyPagination">
                            <!-- Pagination will be generated dynamically -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- User Details Modal -->
    <div class="modal fade" id="userDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-route"></i> Location History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="userDetailsContent">
                        <p class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Detail Modal -->
    <div class="modal fade" id="locationDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-map-marker-alt"></i> Location Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="locationDetailContent">
                    <!-- Content will be populated dynamically -->
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
                        let map;
                   let markers = {};
             let traccarMarkers = {};
             let autoRefreshInterval;

          // Initialize map centered on Oriental Mindoro, Philippines
                function initMap() {
                  map = L.map('map').setView([13.4119, 121.1794], 10);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
           attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19
                   }).addTo(map);
                  }

         // Custom marker icons
         function getMarkerIcon(is_Admin) {
                   const color = is_Admin ===0 ? 'red' : 'blue';
                       return L.divIcon({
                 className: 'custom-marker',
        html: `<div style="background-color: ${color}; width:30px; height:30px; border-radius:50%; border:3px solid white; box-shadow:02px5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
            <i class="fas fa-user" style="color: white; font-size:14px;"></i>
          </div>`,
        iconSize: [30, 30],
                      iconAnchor: [15, 15]
                      });
              }

             function getTraccarIcon() {
         return L.divIcon({
         className: 'traccar-marker',
         html: `<div style="background-color: #28a745; width:28px; height:28px; border-radius:50%; border:3px solid white; box-shadow:02px5px rgba(0,0,0,0.3); display:flex; align-items:center; justify-content:center;">
         <i class="fas fa-bluetooth-b" style="color: white; font-size:14px;"></i>
         </div>`,
         iconSize: [28,28],
         iconAnchor: [14,14]
         });
         }

         // Fetch and display locations (internal app users)
               async function fetchLocations() {
              try {
               const response = await fetch('@Url.Action("GetLatestLocations", "Location")');
           const data = await response.json();

                        if (data.success) {
             updateMap(data.locations);
                   updateUserList(data.locations);
               document.getElementById('activeUserCount').textContent = data.locations.length;
               document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
          } else {
         console.error('Error fetching locations:', data.message);
          }
                } catch (error) {
                    console.error('Error:', error);
            }
             }

         // Fetch and display Traccar positions
         async function fetchTraccarPositions() {
         try {
         const res = await fetch('/api/traccar/positions');
         const payload = await res.json();
         if (!payload.success) return;
         // Clear previous traccar markers
         Object.values(traccarMarkers).forEach(m => map.removeLayer(m));
         traccarMarkers = {};

         payload.positions.forEach(p => {
         const m = L.marker([p.latitude, p.longitude], { icon: getTraccarIcon() }).addTo(map);
         const popup = `
         <div style="min-width:220px;">
         <h6>${p.deviceName || 'Device ' + p.deviceId}</h6>
         <p class="mb-1"><strong>Protocol:</strong> ${p.protocol || 'N/A'}</p>
         <p class="mb-1"><strong>Address:</strong> ${p.address || 'N/A'}</p>
         <p class="mb-1"><strong>Accuracy:</strong> ${p.accuracy ? p.accuracy.toFixed(2) + 'm' : 'N/A'}</p>
         <p class="mb-1"><strong>Device Time:</strong> ${new Date(p.deviceTime).toLocaleString()}</p>
         </div>`;
         m.bindPopup(popup);
         traccarMarkers[p.deviceId] = m;
         });
         } catch (e) {
         console.error('Failed to fetch Traccar positions', e);
         }
         }

                        // Update map markers
                     function updateMap(locations) {
             // Clear existing markers
            Object.values(markers).forEach(marker => map.removeLayer(marker));
                  markers = {};

                // Add new markers
               locations.forEach(location => {
               const marker = L.marker([location.latitude, location.longitude], {
                    icon: getMarkerIcon(location.role)
                  }).addTo(map);

            const popupContent = `
                <div style="min-width: 250px;">
                  <h6>${location.username}</h6>
              <p class="mb-1"><strong>Role:</strong> ${location.role}</p>
          <p class="mb-1"><strong>Email:</strong> ${location.email}</p>
             <p class="mb-1"><strong>Address:</strong> ${location.address || 'Fetching address...'}</p>
                    <p class="mb-1"><strong>Accuracy:</strong> ${location.accuracy ? location.accuracy.toFixed(2) + 'm' : 'N/A'}</p>
                <p class="mb-1"><strong>Last Update:</strong> ${new Date(location.timestamp).toLocaleString()}</p>
                   <button class="btn btn-sm btn-primary mt-2" onclick="viewUserHistory(${location.userId}, '${location.username}')">
                <i class="fas fa-history"></i> View History
             </button>
                           </div>
             `;

                   marker.bindPopup(popupContent);
                   markers[location.userId] = marker;
               });

            // Fit map to show all markers if there are any
               const allLatLngs = [
         ...locations.map(l => [l.latitude, l.longitude]),
         ...Object.values(traccarMarkers).map(m => m.getLatLng() ? [m.getLatLng().lat, m.getLatLng().lng] : null)
         ].filter(Boolean);
         if (allLatLngs.length >0) {
         const bounds = L.latLngBounds(allLatLngs);
         map.fitBounds(bounds, { padding: [50,50] });
         }
        }

            // Update user list
                 function updateUserList(locations) {
                   const userList = document.getElementById('userList');

          if (locations.length === 0) {
               userList.innerHTML = `
               <div class="text-center p-4 text-muted">
                     <i class="fas fa-map-marker-alt fa-2x mb-2"></i>
         <p>No active users at the moment</p>
               </div>
            `;
           return;
                    }

                   userList.innerHTML = locations.map(location => {
                const roleColor = location.role === 'Admin' ? 'danger' : 'primary';
              const timeAgo = getTimeAgo(new Date(location.timestamp));

                      return `
              <div class="list-group-item list-group-item-action" onclick="focusOnUser(${location.userId}, ${location.latitude}, ${location.longitude})" style="cursor: pointer;">
             <div class="d-flex w-100 justify-content-between align-items-center">
               <div>
            <h6 class="mb-1">
          <i class="fas fa-user-circle text-${roleColor}"></i> ${location.username}
               </h6>
               <small class="text-muted">${location.email}</small>
                   <br>
                <span class="badge bg-${roleColor}">${location.role}</span>
                   </div>
            <small class="text-muted">${timeAgo}</small>
               </div>
                     <div class="mt-2">
                   <small class="text-muted">
                     <i class="fas fa-map-marker-alt"></i> ${location.address || 'Address not available'}
              </small>
           </div>
           <div class="mt-1">
          <small class="text-muted">
          <i class="fas fa-map-pin"></i> ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}
                      </small>
                </div>
               </div>
                  `;
                 }).join('');
                  }

                // Focus on specific user
               function focusOnUser(userId, lat, lng) {
             map.setView([lat, lng], 15);
                if (markers[userId]) {
                 markers[userId].openPopup();
                   }
        }

                   // View user history
         async function viewUserHistory(userId, username) {
          const modal = new bootstrap.Modal(document.getElementById('userDetailsModal'));
         document.querySelector('#userDetailsModal .modal-title').innerHTML =
           `<i class="fas fa-route"></i> Location History - ${username}`;

              document.getElementById('userDetailsContent').innerHTML =
          '<p class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</p>';

          modal.show();

                    try {
            const response = await fetch(`@Url.Action("GetUserLocationHistory", "Location")?userId=${userId}&hours=24`);
              const data = await response.json();

               if (data.success) {
        displayUserHistory(data.history);
             } else {
                   document.getElementById('userDetailsContent').innerHTML =
              `<div class="alert alert-danger">${data.message}</div>`;
                         }
                } catch (error) {
            document.getElementById('userDetailsContent').innerHTML =
                       '<div class="alert alert-danger">Error loading history</div>';
          }
          }

               // Display user history
                        function displayUserHistory(history) {
           if (history.length === 0) {
                 document.getElementById('userDetailsContent').innerHTML =
           '<p class="text-muted text-center">No location history available for the last 24 hours.</p>';
                return;
              }

                   const html = `
                   <div class="table-responsive">
                    <table class="table table-striped table-sm">
               <thead>
                     <tr>
             <th>Timestamp</th>
               <th>Address</th>
         <th>Latitude</th>
                <th>Longitude</th>
                      <th>Accuracy</th>
                  </tr>
              </thead>
                       <tbody>
            ${history.map(h => `
              <tr>
         <td>${new Date(h.timestamp).toLocaleString()}</td>
          <td>${h.address || 'N/A'}</td>
                     <td>${h.latitude.toFixed(6)}</td>
            <td>${h.longitude.toFixed(6)}</td>
                    <td>${h.accuracy ? h.accuracy.toFixed(2) + 'm' : 'N/A'}</td>
                   </tr>
          `).join('')}
                    </tbody>
                  </table>
         </div>
                <p class="text-muted mt-2"><small>Total records: ${history.length}</small></p>
                   `;

                  document.getElementById('userDetailsContent').innerHTML = html;
                    }

                     // Get time ago string
                function getTimeAgo(date) {
                 const seconds = Math.floor((new Date() - date) / 1000);

                    if (seconds < 60) return `${seconds}s ago`;
                     if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
               if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
               return `${Math.floor(seconds / 86400)}d ago`;
          }

                        // Auto-refresh functionality
             function setupAutoRefresh() {
                  const toggle = document.getElementById('autoRefreshToggle');

              if (toggle.checked) {
                 autoRefreshInterval = setInterval(fetchLocations, 5000); // 5 seconds
                      }

          toggle.addEventListener('change', function() {
                      if (this.checked) {
                   autoRefreshInterval = setInterval(fetchLocations, 5000);
             } else {
                     clearInterval(autoRefreshInterval);
             }
                });
               }

                  // Manual refresh
               document.getElementById('refreshBtn').addEventListener('click', fetchLocations);

         // ===== LOCATION HISTORY FUNCTIONALITY =====
         let currentHistoryPage = 1;
                let currentFilters = {
                  hours: 24,
          userId: null,
             role: null
         };

                // Load all users for filter dropdown
                async function loadUsersForFilter() {
         try {
          const response = await fetch('@Url.Action("GetAllUsersForFilter", "Location")');
           const data = await response.json();

                  if (data.success) {
                const userFilter = document.getElementById('userFilter');
         userFilter.innerHTML = '<option value="">All Users</option>';

                     data.users.forEach(user => {
                 const option = document.createElement('option');
              option.value = user.userId;
                option.textContent = `${user.username} (${user.email}) - ${user.role}`;
                 userFilter.appendChild(option);
                     });
                }
         } catch (error) {
                 console.error('Error loading users:', error);
          }
                }

                // Fetch location history
            async function fetchLocationHistory(page = 1) {
                    try {
            const params = new URLSearchParams({
                hours: currentFilters.hours,
           page: page,
                  pageSize: 50
            });

          if (currentFilters.userId) {
                 params.append('userId', currentFilters.userId);
                }
                if (currentFilters.role) {
               params.append('role', currentFilters.role);
              }

                        const response = await fetch(`@Url.Action("GetAllUsersLocationHistory", "Location")?${params}`);
                 const data = await response.json();

               if (data.success) {
             displayLocationHistory(data.data);
          updateStatistics(data.statistics);
             updatePagination(data.totalPages, data.currentPage);
                 currentHistoryPage = data.currentPage;
           } else {
                    console.error('Error fetching location history:', data.message);
         displayLocationHistoryError();
              }
                    } catch (error) {
                 console.error('Error:', error);
           displayLocationHistoryError();
                    }
          }

                // Display location history in table
                function displayLocationHistory(locations) {
                const tbody = document.getElementById('locationHistoryBody');

               if (locations.length === 0) {
                 tbody.innerHTML = `
                    <tr>
             <td colspan="8" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
              <p>No location history found for the selected filters.</p>
            </td>
             </tr>
                `;
            return;
                  }

             tbody.innerHTML = locations.map((location, index) => {
                const rowNumber = (currentHistoryPage - 1) * 50 + index + 1;
            const roleColor = location.role === 'Admin' ? 'danger' : 'primary';
            const accuracyColor = location.accuracy < 50 ? 'success' : location.accuracy < 100 ? 'warning' : 'secondary';

              return `
                   <tr>
           <td>${rowNumber}</td>
            <td>
               <strong>${location.username}</strong><br>
                   <small class="text-muted">${location.email}</small>
              </td>
               <td><span class="badge bg-${roleColor}">${location.role}</span></td>
           <td>
               <small>${location.address || '<span class="text-muted">N/A</span>'}</small>
                      </td>
                 <td>
          <small>
            Lat: ${location.latitude.toFixed(6)}<br>
                 Lng: ${location.longitude.toFixed(6)}
                </small>
             </td>
                  <td>
         <span class="badge bg-${accuracyColor}">
         ${location.accuracy ? location.accuracy.toFixed(0) + 'm' : 'N/A'}
                  </span>
             </td>
                     <td>
             <small>${new Date(location.timestamp).toLocaleString()}</small><br>
                 <small class="text-muted">${getTimeAgo(new Date(location.timestamp))}</small>
                      </td>
                    <td>
                    <button class="btn btn-sm btn-info" onclick="showLocationDetail(${location.locationId}, ${location.latitude}, ${location.longitude}, '${location.username}', '${location.address || ''}', '${location.timestamp}')">
                     <i class="fas fa-eye"></i>
                    </button>
                 <button class="btn btn-sm btn-primary" onclick="viewUserHistory(${location.userId}, '${location.username}')">
               <i class="fas fa-history"></i>
                      </button>
              </td>
                 </tr>
             `;
        }).join('');
                }

                // Display error in location history table
          function displayLocationHistoryError() {
                    const tbody = document.getElementById('locationHistoryBody');
                    tbody.innerHTML = `
         <tr>
          <td colspan="8" class="text-center text-danger py-4">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                 <p>Error loading location history. Please try again.</p>
                 </td>
                        </tr>
                    `;
                }

             // Update statistics cards
                function updateStatistics(stats) {
              document.getElementById('totalRecordsCount').textContent = stats.totalRecords;
               document.getElementById('uniqueUsersCount').textContent = stats.uniqueUsers;
                    document.getElementById('avgAccuracyDisplay').textContent = stats.avgAccuracy > 0 ? stats.avgAccuracy.toFixed(0) + 'm' : '0m';
               document.getElementById('dateRangeDisplay').textContent = stats.dateRange;
                }

                // Update pagination
                function updatePagination(totalPages, currentPage) {
                const pagination = document.getElementById('historyPagination');

                    if (totalPages <= 1) {
           pagination.innerHTML = '';
           return;
              }

          let html = '';

              // Previous button
                html += `
                   <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                  <i class="fas fa-chevron-left"></i>
                   </a>
             </li>
                    `;

                    // Page numbers
                    const maxPagesToShow = 5;
                 let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

               if (endPage - startPage < maxPagesToShow - 1) {
           startPage = Math.max(1, endPage - maxPagesToShow + 1);
                    }

                if (startPage > 1) {
                html += `
             <li class="page-item">
                     <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
               </li>
                 `;
              if (startPage > 2) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                 }
              }

                    for (let i = startPage; i <= endPage; i++) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                </li>
             `;
                  }

         if (endPage < totalPages) {
                     if (endPage < totalPages - 1) {
             html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
           }
                   html += `
                  <li class="page-item">
          <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
                  </li>
                `;
                    }

             // Next button
                 html += `
                   <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                       <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
             <i class="fas fa-chevron-right"></i>
                       </a>
                    </li>
                    `;

                 pagination.innerHTML = html;
            }

                // Change page
          function changePage(page) {
                    fetchLocationHistory(page);
                    // Scroll to history section
               document.getElementById('locationHistoryTable').scrollIntoView({ behavior: 'smooth' });
                }

                // Show location detail modal
            function showLocationDetail(locationId, lat, lng, username, address, timestamp) {
                const modal = new bootstrap.Modal(document.getElementById('locationDetailModal'));
                    const content = document.getElementById('locationDetailContent');

                content.innerHTML = `
                 <div class="mb-3">
             <strong><i class="fas fa-user"></i> User:</strong>
            <p class="mb-0">${username}</p>
             </div>
             <div class="mb-3">
          <strong><i class="fas fa-map-marker-alt"></i> Address:</strong>
                <p class="mb-0">${address || '<span class="text-muted">Not available</span>'}</p>
           </div>
           <div class="mb-3">
              <strong><i class="fas fa-map-pin"></i> Coordinates:</strong>
         <p class="mb-0">Latitude: ${lat.toFixed(6)}</p>
                   <p class="mb-0">Longitude: ${lng.toFixed(6)}</p>
                </div>
               <div class="mb-3">
               <strong><i class="fas fa-clock"></i> Timestamp:</strong>
                     <p class="mb-0">${new Date(timestamp).toLocaleString()}</p>
         </div>
            <div class="mb-3">
                     <div id="miniMap" style="height: 250px; width: 100%;"></div>
                  </div>
           <div class="d-grid">
           <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn btn-primary">
                    <i class="fas fa-external-link-alt"></i> Open in Google Maps
                      </a>
              </div>
         `;

           modal.show();

          // Initialize mini map after modal is shown
           setTimeout(() => {
                 const miniMap = L.map('miniMap').setView([lat, lng], 15);
               L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
               attribution: '&copy; OpenStreetMap contributors'
                   }).addTo(miniMap);
                L.marker([lat, lng]).addTo(miniMap);
                    }, 300);
        }

             // Apply filters
                document.getElementById('applyFiltersBtn').addEventListener('click', function() {
                    currentFilters.hours = parseInt(document.getElementById('timeRangeFilter').value);
        currentFilters.userId = document.getElementById('userFilter').value || null;
                    currentFilters.role = document.getElementById('roleFilter').value || null;
                    fetchLocationHistory(1);
             });

                // Export to CSV
                document.getElementById('exportHistoryBtn').addEventListener('click', async function() {
               try {
                     const params = new URLSearchParams({
                 hours: currentFilters.hours,
                  page: 1,
             pageSize: 10000 // Get all records for export
         });

                    if (currentFilters.userId) params.append('userId', currentFilters.userId);
             if (currentFilters.role) params.append('role', currentFilters.role);

                      const response = await fetch(`@Url.Action("GetAllUsersLocationHistory", "Location")?${params}`);
              const data = await response.json();

            if (data.success) {
           exportToCSV(data.data);
                   }
                    } catch (error) {
               console.error('Error exporting:', error);
                alert('Error exporting data. Please try again.');
                    }
                });

                // Export data to CSV
           function exportToCSV(data) {
            const headers = ['Username', 'Email', 'Role', 'Address', 'Latitude', 'Longitude', 'Accuracy', 'Timestamp', 'Device Info'];
                    const csvContent = [
                     headers.join(','),
               ...data.map(row => [
                     `"${row.username}"`,
           `"${row.email}"`,
                 `"${row.role}"`,
        `"${row.address || 'N/A'}"`,
              row.latitude,
               row.longitude,
             row.accuracy || 'N/A',
                 `"${new Date(row.timestamp).toLocaleString()}"`,
                   `"${row.deviceInfo || 'N/A'}"`
              ].join(','))
               ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);

               link.setAttribute('href', url);
            link.setAttribute('download', `location_history_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';

               document.body.appendChild(link);
           link.click();
           document.body.removeChild(link);
                }

         // Initialize
              document.addEventListener('DOMContentLoaded', function() {
            initMap();
            fetchLocations();
            setupAutoRefresh();

                // Initialize location history
             loadUsersForFilter();
                    fetchLocationHistory(1);
              });
    </script>

    <style>
        .custom-marker {
            background: none;
            border: none;
        }

        .list-group-item:hover {
            background-color: #f8f9fa;
        }

        @* Disable card hover animation only on My Location page *@
        body .card:hover {
            transform: none !important;
            box-shadow: 02px8px rgba(0,0,0,0.1) !important;
        }

        /* Location History Table Styles */
        #locationHistoryTable {
            font-size: 0.9rem;
        }

            #locationHistoryTable th {
                position: sticky;
                top: 0;
                background-color: #212529;
                z-index: 10;
            }

            #locationHistoryTable tbody tr:hover {
                background-color: #f0f8ff;
            }

        .pagination .page-link {
            color: #0d6efd;
        }

        .pagination .page-item.active .page-link {
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
    </style>
}
