@model CalapanCarRentalMVC.Models.Rental
@{
    ViewData["Title"] = "Return Car";
    Layout = "_Layout";
}

<div class="container my-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0"><i class="fas fa-check-circle me-2"></i>Mark Rental as Returned</h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> Marking this rental as returned will:
                        <ul class="mb-0 mt-2">
                            <li>Set the actual return date to today</li>
                            <li>Calculate late fees if the car is returned late</li>
                            <li>Mark the rental as completed</li>
                            <li>Set the car status back to "Available"</li>
                            <li><strong>Process the ?2,000 security deposit (refund or forfeit based on vehicle condition)</strong></li>
                        </ul>
                    </div>

                    <h5 class="mb-3">Rental Details</h5>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted">Rental ID</label>
                            <p><strong>#@Model.RentalId</strong></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">Current Status</label>
                            <p><span class="badge bg-success">@Model.Status</span></p>
                        </div>
                    </div>

                    <hr />

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted">Customer</label>
                            <p><strong>@Model.Customer.FirstName @Model.Customer.LastName</strong></p>
                            <small class="text-muted">@Model.Customer.Email</small>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">Vehicle</label>
                            <p><strong>@Model.Car.Brand @Model.Car.Model (@Model.Car.Year)</strong></p>
                            <small class="text-muted">Plate: @Model.Car.PlateNumber</small>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted">Rental Date</label>
                            <p><i class="fas fa-calendar-alt me-1"></i>@Model.RentalDate.ToString("MMMM dd, yyyy")</p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">Expected Return Date</label>
                            <p><i class="fas fa-calendar-check me-1"></i>@Model.ReturnDate.ToString("MMMM dd, yyyy")</p>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-muted">Actual Return Date</label>
                            <p><i class="fas fa-calendar-check me-1 text-success"></i><strong>@DateTime.Now.ToString("MMMM dd, yyyy")</strong></p>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted">Rental Amount</label>
                            <p class="text-primary"><strong>?@Model.TotalAmount.ToString("N2")</strong></p>
                        </div>
                    </div>

                    @if (DateTime.Now > Model.ReturnDate)
                    {
                        var lateDays = (DateTime.Now - Model.ReturnDate).Days;
                        var lateFee = lateDays * (Model.Car.DailyRate * 0.2m);
                        var newTotal = Model.TotalAmount + lateFee;

                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Late Return Detected!</strong>
                            <p class="mb-0 mt-2">
                                The car is being returned <strong>@lateDays day(s)</strong> late.<br />
                                Late fee: <strong>?@lateFee.ToString("N2")</strong> (20% of daily rate per day)<br />
                                New total amount: <strong>?@newTotal.ToString("N2")</strong>
                            </p>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>On-time Return</strong> - No late fees will be charged.
                        </div>
                    }

                    <hr />

                    <form asp-action="Return" method="post">
                        <input type="hidden" asp-for="RentalId" />
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label class="form-label fw-bold">Security Deposit Status</label>
                            <div class="card border-warning">
                                <div class="card-body">
                                    <p class="mb-2">
                                        <i class="fas fa-shield-alt me-1 text-warning"></i>
                                        Security Deposit Amount: <strong>?@Model.SecurityDeposit.ToString("N2")</strong>
                                    </p>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="radio" name="depositStatus" id="depositRefund"
                                            value="Refunded" checked>
                                        <label class="form-check-label" for="depositRefund">
                                            <i class="fas fa-check-circle text-success me-1"></i>
                                            <strong>Refund Deposit</strong> - Vehicle returned without damages
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="depositStatus" id="depositForfeit"
                                            value="Forfeited">
                                        <label class="form-check-label" for="depositForfeit">
                                            <i class="fas fa-times-circle text-danger me-1"></i>
                                            <strong>Forfeit Deposit</strong> - Damages found on vehicle
                                        </label>
                                    </div>
                                    <small class="text-muted d-block mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        The deposit will be refunded to the customer if no damages are found. Otherwise, it will be forfeited to cover repair costs.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="returnNotes" class="form-label">Return Notes (Optional)</label>
                            <textarea name="returnNotes" id="returnNotes" class="form-control" rows="3"
                                placeholder="Add any notes about the vehicle condition, damages, or other remarks..."></textarea>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check-circle me-2"></i>Confirm Return
                            </button>
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
