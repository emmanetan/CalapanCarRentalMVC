@model CalapanCarRentalMVC.Models.Car
@{
    ViewData["Title"] = "Car Details";
    var returnUrl = ViewData["ReturnUrl"] as string;

    // Check if today is the coding day
    bool isCodingDay = false;
    string codingMessage = "";
    if (!string.IsNullOrEmpty(Model.Coding))
    {
        var currentDay = DateTime.Now.DayOfWeek.ToString();
        isCodingDay = Model.Coding.Equals(currentDay, StringComparison.OrdinalIgnoreCase);
        if (isCodingDay)
        {
            codingMessage = $"This vehicle cannot be rented today ({currentDay}) due to coding restrictions.";
        }
    }
}

<div class="container-fluid my-4">
    <div class="row">
        <div class="col-lg-8 col-xl-7 mx-auto">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-car me-2"></i>@Model.Brand @Model.Model</h3>
                </div>
                <div class="card-body">
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @* Warning for customers without driver's license *@
                    @if (Model.Status == "Available" && Context.Session.GetString("UserRole") == "Customer")
                    {
                        var userId = Context.Session.GetString("UserId");
                        if (!string.IsNullOrEmpty(userId))
                        {
                            var customer = ViewBag.CurrentCustomer as CalapanCarRentalMVC.Models.Customer;
                            if (customer != null && (string.IsNullOrWhiteSpace(customer.LicenseNumber) ||
                            string.IsNullOrWhiteSpace(customer.LicenseCode) ||
                            customer.LicenseExpiryDate == default ||
                            string.IsNullOrWhiteSpace(customer.DriverLicensePath)))
                            {
                                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                                    <i class="fas fa-id-card me-2"></i>
                                    <strong>Required Driver's License!</strong> You must complete your driver's license information (License Number, License Code, Expiry Date, and upload your Driver's License document) before proceeding to rent this car.
                                    <a asp-controller="Customer" asp-action="Profile" class="alert-link">Update your profile now</a>
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            }
                        }
                    }

                    @* Warning for coding day *@
                    @if (isCodingDay)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-ban me-2"></i>
                            <strong>Coding Day Restriction!</strong> @codingMessage
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6">
                            @if (!string.IsNullOrEmpty(Model.ImageUrl))
                            {
                                <img src="@Model.ImageUrl" class="img-fluid rounded shadow" alt="@Model.Brand @Model.Model" onerror="this.src='/images/default-car.jpg'" />
                            }
                            else
                            {
                                <div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded" style="height: 300px;">
                                    <i class="fas fa-car fa-5x"></i>
                                </div>
                            }
                        </div>
                        <div class="col-md-6">
                            <h4 class="mb-3">Vehicle Specifications</h4>
                            <table class="table table-borderless">
                                <tr>
                                    <th><i class="fas fa-tag me-2 text-primary"></i>Brand:</th>
                                    <td>@Model.Brand</td>
                                </tr>
                                <tr>
                                    <th><i class="fas fa-car me-2 text-primary"></i>Model:</th>
                                    <td>@Model.Model</td>
                                </tr>
                                <tr>
                                    <th><i class="fas fa-calendar me-2 text-primary"></i>Year:</th>
                                    <td>@Model.Year</td>
                                </tr>
                                <tr>
                                    <th><i class="fas fa-palette me-2 text-primary"></i>Color:</th>
                                    <td>@Model.Color</td>
                                </tr>
                                @if (!string.IsNullOrEmpty(Context.Session.GetString("UserRole")))
                                {
                                    <tr>
                                        <th><i class="fas fa-hashtag me-2 text-primary"></i>Plate Number:</th>
                                        <td>@Model.PlateNumber</td>
                                    </tr>
                                }
                                <tr>
                                    <th><i class="fas fa-ban me-2 text-danger"></i>Coding Day:</th>
                                    <td>
                                        @if (!string.IsNullOrEmpty(Model.Coding))
                                        {
                                            <span class="badge bg-danger">@Model.Coding</span>
                                            <br />
                                            <small class="text-muted">This vehicle cannot be rented on @Model.Coding</small>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Not set</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <th><i class="fas fa-cog me-2 text-primary"></i>Transmission:</th>
                                    <td>@Model.TransmissionType</td>
                                </tr>
                                <tr>
                                    <th><i class="fas fa-users me-2 text-primary"></i>Seating:</th>
                                    <td>@Model.SeatingCapacity Seats</td>
                                </tr>
                                <tr>
                                    <th><i class="fas fa-gas-pump me-2 text-primary"></i>Gas Type:</th>
                                    <td>@Model.GasType</td>
                                </tr>
                                <tr>
                                    <th><i class="fas fa-dollar-sign me-2 text-primary"></i>Daily Rate:</th>
                                    <td><h4 class="text-primary mb-0">@Html.Raw("&#8369;")@Model.DailyRate.ToString("N2")</h4></td>
                                </tr>
                                <tr>
                                    <th><i class="fas fa-info-circle me-2 text-primary"></i>Status:</th>
                                    <td>
                                        @if (Model.Status == "Available")
                                        {
                                            <span class="badge bg-success">Available</span>
                                        }
                                        else if (Model.Status == "Rented")
                                        {
                                            <span class="badge bg-warning">Rented</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">@Model.Status</span>
                                        }
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <hr />
                        <h5 class="mb-3">Description</h5>
                        <p>@Model.Description</p>
                    }

                    <hr />
                    <div class="d-flex gap-2 flex-wrap">
                        @if (Context.Session.GetString("UserRole") == "Admin")
                        {
                            <a asp-action="Edit" asp-route-id="@Model.VehicleId" class="btn btn-edit">
                                <i class="fas fa-edit me-2"></i>Edit
                            </a>
                            <a asp-action="Delete" asp-route-id="@Model.VehicleId" class="btn btn-danger">
                                <i class="fas fa-trash me-2"></i>Delete
                            </a>
                        }
                        else if (Model.Status == "Available" && Context.Session.GetString("UserRole") == "Customer")
                        {
                            @if (isCodingDay)
                            {
                                <button class="btn btn-success" disabled>
                                    <i class="fas fa-ban me-2"></i>Rent This Car (Coding Day)
                                </button>
                            }
                            else
                            {
                                <a asp-controller="Rentals" asp-action="Create" asp-route-carId="@Model.VehicleId" class="btn btn-success">
                                    <i class="fas fa-key me-2"></i>Rent This Car
                                </a>
                            }
                        }
                        else if (Model.Status == "Available" && string.IsNullOrEmpty(Context.Session.GetString("UserRole")))
                        {
                            @if (isCodingDay)
                            {
                                <button class="btn btn-success" disabled>
                                    <i class="fas fa-ban me-2"></i>Rent This Car (Coding Day)
                                </button>
                            }
                            else
                            {
                                <a asp-controller="Rentals" asp-action="Create" asp-route-carId="@Model.VehicleId" class="btn btn-success">
                                    <i class="fas fa-key me-2"></i>Rent This Car
                                </a>
                            }
                        }

                        @if (!string.IsNullOrEmpty(returnUrl))
                        {
                            <a href="@returnUrl" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to List
                            </a>
                        }
                        else
                        {
                            <a asp-action="Index" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Back to List
                            </a>
                        }
                    </div>

                    @if (isCodingDay)
                    {
                        <div class="alert alert-info mt-3" role="alert">
                            <i class="fas fa-info-circle me-2"></i>@codingMessage
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
